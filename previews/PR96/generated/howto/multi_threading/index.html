<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Multi-Threading · RegularizedLeastSquares.jl</title><meta name="title" content="Multi-Threading · RegularizedLeastSquares.jl"/><meta property="og:title" content="Multi-Threading · RegularizedLeastSquares.jl"/><meta property="twitter:title" content="Multi-Threading · RegularizedLeastSquares.jl"/><meta name="description" content="Documentation for RegularizedLeastSquares.jl."/><meta property="og:description" content="Documentation for RegularizedLeastSquares.jl."/><meta property="twitter:description" content="Documentation for RegularizedLeastSquares.jl."/><meta property="og:url" content="https://github.com/JuliaImageRecon/RegularizedLeastSquares.jl/generated/howto/multi_threading/"/><meta property="twitter:url" content="https://github.com/JuliaImageRecon/RegularizedLeastSquares.jl/generated/howto/multi_threading/"/><link rel="canonical" href="https://github.com/JuliaImageRecon/RegularizedLeastSquares.jl/generated/howto/multi_threading/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">RegularizedLeastSquares.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../examples/getting_started/">Getting Started</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/compressed_sensing/">Compressed Sensing</a></li><li><a class="tocitem" href="../../examples/computed_tomography/">Computed Tomography</a></li></ul></li><li><a class="tocitem" href="../../../solvers/">Solvers</a></li><li><a class="tocitem" href="../../explanations/regularization/">Regularization</a></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox" checked/><label class="tocitem" for="menuitem-6"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../weighting/">Weighting</a></li><li><a class="tocitem" href="../normal_operator/">Normal Operator</a></li><li class="is-active"><a class="tocitem" href>Multi-Threading</a><ul class="internal"><li><a class="tocitem" href="#Solver-Based-Multi-Threading"><span>Solver Based Multi-Threading</span></a></li><li><a class="tocitem" href="#Operator-Based-Multi-Threading"><span>Operator Based Multi-Threading</span></a></li><li><a class="tocitem" href="#Measurement-Based-Multi-Threading"><span>Measurement Based Multi-Threading</span></a></li><li><a class="tocitem" href="#Custom-Scheduling"><span>Custom Scheduling</span></a></li></ul></li><li><a class="tocitem" href="../gpu_acceleration/">GPU Acceleration</a></li><li><a class="tocitem" href="../efficient_kaczmarz/">Efficient Kaczmarz</a></li><li><a class="tocitem" href="../callbacks/">Callbacks</a></li><li><a class="tocitem" href="../plug-and-play/">Plug-and-Play Regularization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">API Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../API/solvers/">Solvers</a></li><li><a class="tocitem" href="../../../API/regularization/">Regularization Terms</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to</a></li><li class="is-active"><a href>Multi-Threading</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Multi-Threading</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaImageRecon/RegularizedLeastSquares.jl/blob/master/docs/src/literate/howto/multi_threading.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Multi-Threading"><a class="docs-heading-anchor" href="#Multi-Threading">Multi-Threading</a><a id="Multi-Threading-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-Threading" title="Permalink"></a></h1><p>There are different ways multi-threading can be used with RegularizedLeastSquares.jl. To use multi-threading in Julia, one needs to start their session with multi-threads, see the <a href="https://docs.julialang.org/en/v1/manual/multi-threading/">Julia documentation</a> for more information.</p><h2 id="Solver-Based-Multi-Threading"><a class="docs-heading-anchor" href="#Solver-Based-Multi-Threading">Solver Based Multi-Threading</a><a id="Solver-Based-Multi-Threading-1"></a><a class="docs-heading-anchor-permalink" href="#Solver-Based-Multi-Threading" title="Permalink"></a></h2><p>This type of multi-threading is transparent to the solver and is applicable if the total solution is composed of individual solutions that can be solved in parallel. In particular, this approach also allows for using solvers with different parameters, such as their operator or regularization parameters.</p><pre><code class="language-julia hljs">using RegularizedLeastSquares
As = [rand(32, 16) for _ in 1:4]
xs = [rand(16) for _ in 1:4]
bs = [A*x for (A, x) in zip(As, xs)]

xs_approx = similar(xs)
Threads.@threads for i in 1:4
  solver = createLinearSolver(CGNR, As[i]; iterations=32)
  xs_approx[i] = solve!(solver, bs[i])
end</code></pre><h2 id="Operator-Based-Multi-Threading"><a class="docs-heading-anchor" href="#Operator-Based-Multi-Threading">Operator Based Multi-Threading</a><a id="Operator-Based-Multi-Threading-1"></a><a class="docs-heading-anchor-permalink" href="#Operator-Based-Multi-Threading" title="Permalink"></a></h2><p>This type of multi-threading involves linear operators or proximal maps that can be implemnted in parallel. Examples of this include the proximal map of the TV regularization term, which is based on the multi-threaded GradientOp from LinearOperatorCollection. GPU acceleration also falls under this approach, see <a href="../gpu_acceleration/">GPU Acceleration</a> for more information.</p><h2 id="Measurement-Based-Multi-Threading"><a class="docs-heading-anchor" href="#Measurement-Based-Multi-Threading">Measurement Based Multi-Threading</a><a id="Measurement-Based-Multi-Threading-1"></a><a class="docs-heading-anchor-permalink" href="#Measurement-Based-Multi-Threading" title="Permalink"></a></h2><p>This level of multi-threading applies the same solver (and its parameters) to multiple measurement vectors or rather a measurement matrix B. This is useful in the case of multiple measurements that can be solved in parallel and can reuse the same solver. This approach is not applicable if the operator is stateful.</p><p>To use this approach we first build a measurement matrix B and a corresponding solver:</p><pre><code class="language-julia hljs">A = first(As)
B = mapreduce(x -&gt; A*x, hcat, xs)
solver = createLinearSolver(CGNR, A; iterations=32)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">CGNR{Matrix{Float64}, Matrix{Float64}, L2Regularization{Float64}, Vector{Any}}([0.6456067368088206 0.8539068117039385 … 0.7575839413725725 0.46323803790274554; 0.28104396693807365 0.01748805470457393 … 0.30864276827223314 0.4518382108575173; … ; 0.9375999693377676 0.9301721309797958 … 0.6803734955382333 0.8316249882969814; 0.7443210976839 0.9991767072893716 … 0.24936449893339963 0.9030518190843101], [10.006988744877148 7.301468249338812 … 7.823516684469723 7.399966819462663; 7.301468249338812 11.166172677994275 … 7.630059136896189 6.612726012999459; … ; 7.823516684469723 7.630059136896189 … 9.190661026809162 5.951825762900545; 7.399966819462663 6.612726012999459 … 5.951825762900545 9.79825474215464], L2Regularization{Float64}(0.0), Any[], NoNormalization(), 32, RegularizedLeastSquares.CGNRState{Float64, Float64, Vector{Float64}}([9.8e-321, 6.9200946199289e-310, 6.92013251299416e-310, 0.0, 9.8e-321, 6.92011163487645e-310, 5.0e-324, 5.0e-324, 6.92019028170597e-310, 0.0, 9.8e-321, 5.0e-324, 5.0e-324, 9.8e-321, 5.0e-324, 6.920164012966e-310], [9.8e-321, 6.9200946199289e-310, 6.92013251299416e-310, 0.0, 9.8e-321, 6.92011163487645e-310, 5.0e-324, 5.0e-324, 6.92019028170597e-310, 0.0, 9.8e-321, 5.0e-324, 5.0e-324, 9.8e-321, 5.0e-324, 6.92016401296916e-310], [9.8e-321, 6.9200946199289e-310, 6.92013251299416e-310, 0.0, 9.8e-321, 6.92011163487645e-310, 5.0e-324, 5.0e-324, 6.92019028170597e-310, 0.0, 9.8e-321, 5.0e-324, 5.0e-324, 9.8e-321, 5.0e-324, 6.92016401297233e-310], [9.8e-321, 6.9200946199289e-310, 6.92013251299416e-310, 0.0, 9.8e-321, 6.92011163487645e-310, 5.0e-324, 5.0e-324, 6.92019028170597e-310, 0.0, 9.8e-321, 5.0e-324, 5.0e-324, 9.8e-321, 5.0e-324, 6.92016401298497e-310], 0.0, 0.0, 0.0, 0, 2.220446049250313e-16, 0.0))</code></pre><p>We can then simply pass the measurement matrix to the solver. The result will be the same as if we passed each colument of B seperately:</p><pre><code class="language-julia hljs">x_approx = solve!(solver, B)
size(x_approx)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(16, 4)</code></pre><p>The previous <code>solve!</code> call was still executed sequentially. To execute it in parallel, we have to specify a multi-threaded <code>scheduler</code> as a keyword-argument of the <code>solve!</code> call. RegularizedLeastSquares.jl provides a <code>MultiThreadingState</code> scheduler that can be used for this purpose. This scheduler is based on the <code>Threads.@threads</code> macro:</p><pre><code class="language-julia hljs">x_multi = solve!(solver, B; scheduler = MultiThreadingState)
x_approx == x_multi</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><h2 id="Custom-Scheduling"><a class="docs-heading-anchor" href="#Custom-Scheduling">Custom Scheduling</a><a id="Custom-Scheduling-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-Scheduling" title="Permalink"></a></h2><p>It is possible to implement custom scheduling. The following code shows how to implement this for the <code>Threads.@spawn</code> macro. Usually one this to implement multi-threading with a package such as FLoop.jl or ThreadPools.jl for thread pinning:</p><p>Since most solver have conv. criteria, they can finish at different iteration numbers, which we track this information with flags.</p><pre><code class="language-julia hljs"> mutable struct SpawnState{S, ST &lt;: AbstractSolverState{S}} &lt;: RegularizedLeastSquares.AbstractMatrixSolverState{S}
   states::Vector{ST}
   active::Vector{Bool}
   SpawnState(states::Vector{ST}) where {S, ST &lt;: AbstractSolverState{S}} = new{S, ST}(states, fill(true, length(states)))
 end</code></pre><p>To hook into the existing init! code we only have to supply a method that gets a copyable &quot;vector&quot; state. This will invoke our SpawnState constructor with copies of the given state.</p><pre><code class="language-julia hljs"> prepareMultiStates(solver::AbstractLinearSolver, state::SpawnState, b::AbstractMatrix) = prepareMultiStates(solver, first(state.states), b);</code></pre><p>We specialise the iterate function which is called with the idx of still active states</p><pre><code class="language-julia hljs">function Base.iterate(solver::AbstractLinearSolver, state::SpawnState, activeIdx)
  @sync Threads.@spawn for i in activeIdx
    res = iterate(solver, state.states[i])
    if isnothing(res)
      state.active[i] = false
    end
  end
  return state.active, state
end</code></pre><p>Now we can simply use the SpawnState scheduler in the solve! call:</p><pre><code class="language-julia hljs">x_custom = solve!(solver, B; scheduler = SpawnState)
x_approx == x_multi</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../normal_operator/">« Normal Operator</a><a class="docs-footer-nextpage" href="../gpu_acceleration/">GPU Acceleration »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Tuesday 26 November 2024 15:21">Tuesday 26 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
